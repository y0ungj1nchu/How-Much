------------------------------------------------------------
-- 1) 기존 객체 제거 (DROP)
------------------------------------------------------------

-- SEQUENCES
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_TM'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_CATS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_SUB_CATS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_FIXED_EXP'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_TX'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_BUDGETS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- TABLES
BEGIN EXECUTE IMMEDIATE 'DROP TABLE INSTALLMENTS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE TRANSACTIONS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE FIXED_EXPENSES CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE BUDGETS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE SUB_CATEGORIES CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE CATEGORIES CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE TRANSACTION_METHODS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

------------------------------------------------------------
-- 2) 시퀀스 생성
------------------------------------------------------------

CREATE SEQUENCE SEQ_TM          START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_CATS        START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_SUB_CATS    START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_FIXED_EXP   START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_TX          START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_BUDGETS     START WITH 1 INCREMENT BY 1;

------------------------------------------------------------
-- 3) 테이블 생성
------------------------------------------------------------

CREATE TABLE TRANSACTION_METHODS (
    TM_ID        NUMBER         NOT NULL,
    NAME         VARCHAR2(50)   NOT NULL,
    TYPE         VARCHAR2(10)   NOT NULL,
    BALANCE      NUMBER         DEFAULT 0,
    BILLING_DAY  NUMBER         DEFAULT NULL,
    CONSTRAINT PK_TM PRIMARY KEY (TM_ID)
);

CREATE TABLE CATEGORIES (
    CATEGORY_ID  NUMBER          NOT NULL,
    NAME         VARCHAR2(50)    NOT NULL,
    TYPE         VARCHAR2(10)    NOT NULL,
    CONSTRAINT PK_CATS PRIMARY KEY (CATEGORY_ID)
);

CREATE TABLE SUB_CATEGORIES (
    SUB_ID        NUMBER          NOT NULL,
    CATEGORY_ID   NUMBER          NOT NULL,
    NAME          VARCHAR2(50)    NOT NULL,
    CONSTRAINT PK_SUB_CATS PRIMARY KEY (SUB_ID),
    CONSTRAINT FK_SUB_CATS FOREIGN KEY (CATEGORY_ID)
        REFERENCES CATEGORIES(CATEGORY_ID)
);

CREATE TABLE BUDGETS (
    BUDGET_ID    NUMBER         NOT NULL,
    CATEGORY_ID  NUMBER         NOT NULL,
    YYYYMM       VARCHAR2(6)    NOT NULL,
    AMOUNT       NUMBER         DEFAULT 0,
    CONSTRAINT PK_BUDGETS PRIMARY KEY (BUDGET_ID),
    CONSTRAINT FK_BUDGET_CATS FOREIGN KEY (CATEGORY_ID)
        REFERENCES CATEGORIES(CATEGORY_ID)
);

CREATE TABLE FIXED_EXPENSES (
    FIXED_EXP_ID NUMBER          NOT NULL,
    SUB_ID       NUMBER          NOT NULL,
    TM_ID        NUMBER          NOT NULL,
    NAME         VARCHAR2(100)   NOT NULL,
    AMOUNT       NUMBER          NOT NULL,
    CYCLE_TYPE   VARCHAR2(10)    DEFAULT 'MONTHLY',
    CYCLE_DAY    NUMBER          NOT NULL,
    START_DATE   DATE            DEFAULT SYSDATE,
    END_DATE     DATE            DEFAULT NULL,
    CONSTRAINT PK_FIXED_EXP PRIMARY KEY (FIXED_EXP_ID),
    CONSTRAINT FK_FIXED_SUB FOREIGN KEY (SUB_ID)
        REFERENCES SUB_CATEGORIES(SUB_ID),
    CONSTRAINT FK_FIXED_TM FOREIGN KEY (TM_ID)
        REFERENCES TRANSACTION_METHODS(TM_ID)
);

CREATE TABLE TRANSACTIONS (
    TX_ID         NUMBER         NOT NULL,
    TM_ID         NUMBER         NOT NULL,
    SUB_ID        NUMBER         NOT NULL,
    FIXED_EXP_ID  NUMBER         DEFAULT NULL,
    AMOUNT        NUMBER         NOT NULL,
    TX_DATE       DATE           DEFAULT SYSDATE NOT NULL,
    MEMO          VARCHAR2(200),
    CREATED_AT    DATE           DEFAULT SYSDATE,
    CONSTRAINT PK_TX PRIMARY KEY (TX_ID),
    CONSTRAINT FK_TX_TM FOREIGN KEY (TM_ID)
        REFERENCES TRANSACTION_METHODS(TM_ID),
    CONSTRAINT FK_TX_SUB FOREIGN KEY (SUB_ID)
        REFERENCES SUB_CATEGORIES(SUB_ID),
    CONSTRAINT FK_TX_FIXED FOREIGN KEY (FIXED_EXP_ID)
        REFERENCES FIXED_EXPENSES(FIXED_EXP_ID)
);

CREATE TABLE INSTALLMENTS (
    TX_ID          NUMBER        NOT NULL,
    TOTAL_MONTHS   NUMBER        NOT NULL,
    CURRENT_MONTH  NUMBER        NOT NULL,
    CONSTRAINT PK_INST PRIMARY KEY (TX_ID),
    CONSTRAINT FK_INST_TX FOREIGN KEY (TX_ID)
        REFERENCES TRANSACTIONS(TX_ID) ON DELETE CASCADE
);

------------------------------------------------------------
-- 4) 초기 데이터 INSERT
------------------------------------------------------------

INSERT INTO TRANSACTION_METHODS VALUES (1, '신한은행', 'BANK', 5000000, NULL);
INSERT INTO TRANSACTION_METHODS VALUES (2, '현대카드', 'CARD', -450000, 25);
INSERT INTO TRANSACTION_METHODS VALUES (3, '현금', 'CASH', 30000, NULL);

INSERT INTO CATEGORIES VALUES (1, '식비', 'EXPENSE');
INSERT INTO CATEGORIES VALUES (2, '교통', 'EXPENSE');
INSERT INTO CATEGORIES VALUES (3, '쇼핑', 'EXPENSE');
INSERT INTO CATEGORIES VALUES (4, '급여', 'INCOME');

INSERT INTO SUB_CATEGORIES VALUES (1, 1, '외식');
INSERT INTO SUB_CATEGORIES VALUES (2, 1, '카페/베이커리');
INSERT INTO SUB_CATEGORIES VALUES (3, 1, '배달음식');
INSERT INTO SUB_CATEGORIES VALUES (4, 2, '버스');
INSERT INTO SUB_CATEGORIES VALUES (5, 2, '지하철');
INSERT INTO SUB_CATEGORIES VALUES (6, 3, '의류');
INSERT INTO SUB_CATEGORIES VALUES (7, 3, '잡화');
INSERT INTO SUB_CATEGORIES VALUES (8, 4, '정기급여');
INSERT INTO SUB_CATEGORIES VALUES (9, 4, '상여금');

INSERT INTO BUDGETS VALUES (SEQ_BUDGETS.NEXTVAL, 1, '202511', 500000);
INSERT INTO BUDGETS VALUES (SEQ_BUDGETS.NEXTVAL, 2, '202511', 150000);
INSERT INTO BUDGETS VALUES (SEQ_BUDGETS.NEXTVAL, 3, '202511', 1000000);

INSERT INTO FIXED_EXPENSES VALUES (
    SEQ_FIXED_EXP.NEXTVAL, 
    7, 2, 
    '넷플릭스', 
    17000, 
    'MONTHLY', 
    1, 
    SYSDATE, 
    NULL
);

------------------------------------------------------------
-- ⚠ 거래내역 INSERT 수정됨 (컬럼명 명시)
------------------------------------------------------------

INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 1, 8, NULL,
    3000000,
    TO_DATE('2025-11-10 09:00','YYYY-MM-DD HH24:MI'),
    '11월 급여'
);

INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 2, 1, NULL,
    9000,
    TO_DATE('2025-11-11 12:30','YYYY-MM-DD HH24:MI'),
    '점심'
);

INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 2, 4, NULL,
    15000,
    TO_DATE('2025-11-12 23:40','YYYY-MM-DD HH24:MI'),
    '버스 충전'
);

INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 3, 3, NULL,
    4500,
    TO_DATE('2025-11-13 13:00','YYYY-MM-DD HH24:MI'),
    '배달 라면'
);

INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 2, 6, NULL,
    1200000,
    TO_DATE('2025-11-15 15:00','YYYY-MM-DD HH24:MI'),
    '의류 구매'
);

-- 할부 정보
INSERT INTO INSTALLMENTS VALUES (SEQ_TX.CURRVAL, 3, 1);

-- 넷플릭스 자동결제
INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 2, 7, 1,
    17000,
    TO_DATE('2025-11-01 10:00','YYYY-MM-DD HH24:MI'),
    '넷플릭스 자동결제'
);

-- 12/01 점심 식비 (외식 - SUB_ID = 1)
INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 2, 1, NULL,
    8500,
    TO_DATE('2025-12-01 12:20','YYYY-MM-DD HH24:MI'),
    '점심 외식'
);

-- 12/02 커피 (카페/베이커리 - SUB_ID = 2)
INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 3, 2, NULL,
    4800,
    TO_DATE('2025-12-02 09:10','YYYY-MM-DD HH24:MI'),
    '출근길 아메리카노'
);

-- 12/03 버스 (SUB_ID = 4)
INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 3, 4, NULL,
    1250,
    TO_DATE('2025-12-03 08:45','YYYY-MM-DD HH24:MI'),
    '출근 버스'
);

-- 12/04 배달 음식 (SUB_ID = 3)
INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 2, 3, NULL,
    18500,
    TO_DATE('2025-12-04 18:40','YYYY-MM-DD HH24:MI'),
    '저녁 배달'
);

-- 12/05 12월 급여 (정기급여 SUB_ID = 8)
INSERT INTO TRANSACTIONS (
    TX_ID, TM_ID, SUB_ID, FIXED_EXP_ID, AMOUNT, TX_DATE, MEMO
) VALUES (
    SEQ_TX.NEXTVAL, 1, 8, NULL,
    3000000,
    TO_DATE('2025-12-05 08:00','YYYY-MM-DD HH24:MI'),
    '12월 급여'
);


COMMIT;